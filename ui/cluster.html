<!DOCTYPE html>
<html>

<head>
    <title>Deployer</title>
    <link rel="import" href="/static/common/linkCss.html">
    <link rel="import" href="/static/common/linkJs.html">
    <script>
        $(function() {
            $('.deployment-list li').click(function() {
                if ($(this).data('status') == 'Available') {
                    $('.cluster-detail').show();

                    var clusterName = $(this).data('name');
                    var deploymentType = $(this).data('type');
                    if (deploymentType == 'K8S') {
                        $('#podDiv').show();
                        $('#taskDiv').hide();
                    }
                    if (deploymentType == 'ECS') {
                        $('#podDiv').hide();
                        $('#taskDiv').show();
                    }

                    getClusterInfo(clusterName, deploymentType);
                } else {
                    $('.cluster-detail').hide();
                }
            });
        });

        function getClusterInfo(clusterName, deploymentType) {
            $.ajax({
                url: '/ui/clusters/' + deploymentType + '/' + clusterName,
                type: 'GET',
                dataType: 'json',
                success: function(json) {
                    if (json.error == false) {
                        if (json.BastionIp) {
                          $('div.alert-info span').text(json.BastionIp);
                          $('div.alert-info').show();
                        } else {
                          $('div.alert-info').hide();
                        }

                        showClusterCnt(deploymentType, json.data);
                        showClusterNodes(deploymentType, json.data);
                        showClusterNodesDetail(deploymentType, json.data);
                        showClusterPods(deploymentType, json.data);
                        showClusterTasks(deploymentType, json.data);
                        showClusterContainers(deploymentType, json.data);
                    } else {
                        alert(json.data)
                    }
                }
            });
        }

        function showClusterCnt(deploymentType, data) {
            switch (deploymentType) {
                case 'K8S':
                    $('#node-cnt').html(data.Nodes.length);
                    $('#pod-cnt').html(data.Pods.length);
                    $('#container-cnt').html(data.Containers.length);
                    break;
                case 'ECS':
                    $('#node-cnt').html(data.ContainerInstances.length);
                    $('#task-cnt').html(data.Tasks.length);

                    var containerCnt = 0;
                    $.each(data.Tasks, function(i, task) {
                        $.each(task.Containers, function(j, container) {
                            containerCnt++;
                        });
                    });
                    $('#container-cnt').html(containerCnt);
                    break;
                default:
                    console.log('Unsupported deploymentType type: ' + deploymentType + '.');
            }
        }

        function showClusterNodes(deploymentType, data) {
            switch (deploymentType) {
                case 'K8S':
                    $('#node-info').html('');
                    $.each(data.Nodes, function(index, node) {
                        var nodeName = '';
                        nodeName += '<table>';
                        nodeName += '    <tr>';
                        nodeName += '        <td width="300px">' + node.metadata.name + '</td>';
                        nodeName += '        <td>';
                        nodeName += '            <div class="node-icon">' + addPodIcon(node.metadata.name, data.Pods) + '</div>';
                        nodeName += '        </td>';
                        nodeName += '        <td style="color:red">master</td>';
                        nodeName += '    </tr>';
                        nodeName += '</table>';

                        for (var key in node.metadata.labels) {
                            if (key == 'node-role.kubernetes.io/master') {
                                $('#node-info').append('<a href="#" onclick="showNodeInfo(\'node' + index + '\');">' + nodeName + '</a>');
                            }
                        }
                    });

                    for (var i = 1; i <= (data.Nodes.length - 1); i++) {
                        $.each(data.Nodes, function(index, node) {
                            var nodeName = '';
                            nodeName += '<table>';
                            nodeName += '    <tr>';
                            nodeName += '        <td width="300px">' + node.metadata.name + '</td>';
                            nodeName += '        <td>';
                            nodeName += '            <div class="node-icon">' + addPodIcon(node.metadata.name, data.Pods) + '</div>';
                            nodeName += '        </td>';
                            nodeName += '        <td style="color:red">hyperpilot/node-id: ' + i + '</td>';
                            nodeName += '    </tr>';
                            nodeName += '</table>';

                            for (var key in node.metadata.labels) {
                                if (key == 'hyperpilot/node-id' && node.metadata.labels[key] == i) {
                                    $('#node-info').append('<a href="#" onclick="showNodeInfo(\'node' + index + '\');">' + nodeName + '</a>');
                                    break;
                                }
                            }
                        });
                    }
                    break;
                case 'ECS':
                    $('#node-info').html('');
                    $.each(data.Reservations, function(index, reservation) {
                        var nodeIconHtml = addTaskIcon(reservation.Instances[0].PublicDnsName, data);

                        var nodeName = '';
                        nodeName += '<table>';
                        nodeName += '    <tr>';
                        nodeName += '        <td width="500px">' + reservation.Instances[0].PublicDnsName + '</td>';
                        nodeName += '        <td>';
                        nodeName += '            <div class="node-icon">' + addTaskIcon(reservation.Instances[0].PublicDnsName, data) + '</div>';
                        nodeName += '        </td>';
                        nodeName += '    </tr>';
                        nodeName += '</table>';

                        $('#node-info').append('<a href="#" onclick="showNodeInfo(\'node' + index + '\');">' + nodeName + '</a>');
                    });
                    break;
                default:
                    console.log('Unsupported deploymentType type: ' + deploymentType + '.');
            }
        }

        function showClusterNodesDetail(deploymentType, data) {
            switch (deploymentType) {
                case 'K8S':
                    $.each(data.Nodes, function(i, node) {
                        var nodeName = node.metadata.name;
                        var nodesDetails = [];
                        nodesDetails.push('<div class="data-info" id="node' + i + '" style="display:none">');
                        nodesDetails.push('<div class="data-header">Node：' + nodeName + '</div>');
                        nodesDetails.push('<div class="data-labels">Lables:</div>');
                        appendAttrs(nodesDetails, node.metadata.labels);

                        $.each(data.Pods, function(j, pod) {
                            if (pod.spec.nodeName == nodeName) {
                                nodesDetails.push('<div class="data-info">');
                                nodesDetails.push('<div class="data-header">Pod：' + pod.metadata.name + '</div>');
                                nodesDetails.push('<div class="data-labels">Lables:</div>');
                                appendAttrs(nodesDetails, pod.metadata.labels);
                                nodesDetails.push('<div class="data-labels">StartTime：' + pod.status.startTime + '</div>');
                                nodesDetails.push('<div class="data-labels">Status：' + pod.status.phase + '</div>');

                                $.each(pod.spec.containers, function(k, container) {
                                    nodesDetails.push('<div class="data-info">');
                                    nodesDetails.push('<div class="data-header">Container：' + container.name + '</div>');
                                    nodesDetails.push('<div class="data-labels">Image：' + container.image + '</div>');

                                    if (container.ports) {
                                        nodesDetails.push('<div class="data-labels">Ports:</div>');
                                        appendIndexAttrs(nodesDetails, container.ports);
                                    }

                                    if (container.resources.requests) {
                                        nodesDetails.push('<div class="data-labels">Requests:</div>');
                                        appendAttrs(nodesDetails, container.resources.requests);
                                    }

                                    if (container.resources.limits) {
                                        nodesDetails.push('<div class="data-labels">Limits:</div>');
                                        appendAttrs(nodesDetails, container.resources.limits);
                                    }
                                    nodesDetails.push('</div>');
                                });
                                nodesDetails.push('</div>');
                            }
                        });
                        nodesDetails.push('</div>');

                        $('#node-detail').append(nodesDetails.join(''));
                    });
                    break;
                case 'ECS':
                    $.each(data.Reservations, function(i, reservation) {
                        var nodeName = reservation.Instances[0].PublicDnsName;
                        var instanceId = reservation.Instances[0].InstanceId;
                        var containerInstanceArn = '';
                        $.each(data.ContainerInstances, function(j, containerInstance) {
                            if (containerInstance.Ec2InstanceId == instanceId) {
                                containerInstanceArn = containerInstance.ContainerInstanceArn;
                            }
                        });

                        var nodesDetails = [];
                        nodesDetails.push('<div class="data-info" id="node' + i + '" style="display:none">');
                        nodesDetails.push('<div class="data-header">Node：' + nodeName + '</div>');

                        $.each(data.Tasks, function(k, task) {
                            if (task.ContainerInstanceArn == containerInstanceArn) {
                                var taskName = task.TaskDefinitionArn.split('task-definition/')[1];
                                nodesDetails.push('<div class="data-info">');
                                nodesDetails.push('<div class="data-header">Task：' + taskName + '</div>');

                                $.each(task.Containers, function(m, container) {
                                    nodesDetails.push('<div class="data-info">');
                                    nodesDetails.push('<div class="data-header">Container: ' + container.Name + '</div>');
                                    nodesDetails.push('</div>');
                                });
                                nodesDetails.push('</div>');
                            }
                        });
                        nodesDetails.push('</div>');

                        $('#node-detail').append(nodesDetails.join(''));
                    });
                    break;
                default:
                    console.log('Unsupported deploymentType type: ' + deploymentType + '.');
            }
        }

        function showClusterPods(deploymentType, data) {
            if (deploymentType != 'K8S') {
                return;
            }

            $('#pod-info').html('');
            $.each(data.Pods, function(i, pod) {
                $('#pod-info').append('<a href="#">' + pod.metadata.name + '</a>')
            });
        }

        function showClusterTasks(deploymentType, data) {
            if (deploymentType != 'ECS') {
                return;
            }

            $('#task-info').html('');
            $.each(data.Tasks, function(i, task) {
                var taskName = task.TaskDefinitionArn.split('task-definition/')[1];
                $('#task-info').append('<a href="#">' + taskName + '</a>')
            });
        }

        function showClusterContainers(deploymentType, data) {
            switch (deploymentType) {
                case 'K8S':
                    $('#container-info').html('');
                    $.each(data.Containers, function(i, container) {
                        $('#container-info').append('<a href="#">' + container.metadata.name + '</a>')
                    });
                    break;
                case 'ECS':
                    $('#container-info').html('');
                    $.each(data.Tasks, function(i, task) {
                        $.each(task.Containers, function(j, container) {
                            $('#container-info').append('<a href="#">' + container.Name + '</a>')
                        });
                    });
                    break;
                default:
                    console.log('Unsupported deploymentType type: ' + deploymentType + '.');
            }
        }

        function showNodeInfo(nodeName) {
            $('#node-detail > div').hide()
            $('#' + nodeName).show();
        }

        function appendAttrs(nodesDetails, obj) {
            if (obj) {
                for (var key in obj) {
                    nodesDetails.push('<div class="data-labels">&nbsp;&nbsp;&nbsp;&nbsp;' + (key + ":" + obj[key]) + '</div>');
                }
            }
        }

        function appendIndexAttrs(nodesDetails, obj) {
            if (obj) {
                for (var index in obj) {
                    for (var key in obj[index]) {
                        nodesDetails.push('<div class="data-labels">&nbsp;&nbsp;&nbsp;&nbsp;' + (key + ":" + obj[index][key]) + '</div>');
                    }
                }
            }
        }

        function addPodIcon(nodeName, pods) {
            var podHtml = '';
            $.each(pods, function(i, pod) {
                if (pod.spec.nodeName == nodeName) {
                    var bgColor = (pod.status.phase == 'Running' ? '#00FF00' : '#FF0000');
                    podHtml += '<div class="pod-icon" style="background-color: ' + bgColor + '"></div>';
                }
            });
            return podHtml;
        }

        function addTaskIcon(publicDnsName, data) {
            var taskHtml = '';
            var instanceId = '';
            $.each(data.Reservations, function(i, reservation) {
                if (reservation.Instances[0].PublicDnsName == publicDnsName) {
                    instanceId = reservation.Instances[0].InstanceId;
                }
            });

            var containerInstanceArn = '';
            $.each(data.ContainerInstances, function(i, containerInstance) {
                if (containerInstance.Ec2InstanceId == instanceId) {
                    containerInstanceArn = containerInstance.ContainerInstanceArn;
                }
            });

            $.each(data.Tasks, function(i, task) {
                if (task.ContainerInstanceArn == containerInstanceArn) {
                    var bgColor = (task.LastStatus == 'RUNNING' ? '#00FF00' : '#FF0000');
                    taskHtml += '<div class="pod-icon" style="background-color: ' + bgColor + '"></div>';
                }
            });
            return taskHtml;
        }
    </script>
</head>

<body>
    <!-- header -->
    <header>
        <nav>
            <a href="/ui" class="banner">Deployer</a>
            <ul>
                <li>
                    <a href="/ui">deployments</a>
                </li>
                <li>
                    <a href="/ui/clusters" class="active">clusters</a>
                </li>
                <li>
                    <a href="/ui/users">users</a>
                </li>
            </ul>
        </nav>
    </header>

    <!-- sidebar -->
    <aside>
        <ul class="deployment-list">
            {{range $k,$v := .logs}}
            <li class="deployment" data-name="{{$v.Name}}" data-type="{{$v.Type}}" data-status="{{$v.Status}}">
                <div class="logName">{{$v.Name}}</div>
                <span class="logTime">{{$v.Time}}</span>
                <span class="badge badge-{{$v.Status}}">{{$v.Status}}</span>
            </li>
            {{end}}
        </ul>
    </aside>

    <!-- main -->
    <main>
        <h1>{{.msg}}!</h1>
        <div class="alert alert-info" role="alert" style="display: none; margin-top: 3px; font-size: 20px;"><strong>Bastion IP : </strong><span></span></div>
        <div class="cluster-detail">
            <div>
                <div class="header">Nodes</div>
                <div class="content">
                    <div id="node-cnt" class="large"></div>
                    <div class="small">Total</div>
                    <div class="dropdown"><i class="fa fa-caret-down"></i></div>
                    <div id="node-info" class="dropdown-content">
                    </div>
                </div>
            </div>
            <div id="podDiv">
                <div class="header">Pods</div>
                <div class="content">
                    <div id="pod-cnt" class="large"></div>
                    <div class="small">Total</div>
                    <div class="dropdown"><i class="fa fa-caret-down"></i></div>
                    <div id="pod-info" class="dropdown-content"></div>
                </div>
            </div>
            <div id="taskDiv">
                <div class="header">Tasks</div>
                <div class="content">
                    <div id="task-cnt" class="large"></div>
                    <div class="small">Total</div>
                    <div class="dropdown"><i class="fa fa-caret-down"></i></div>
                    <div id="task-info" class="dropdown-content"></div>
                </div>
            </div>
            <div>
                <div class="header">Containers</div>
                <div class="content">
                    <div id="container-cnt" class="large"></div>
                    <div class="small">Total</div>
                    <div class="dropdown"><i class="fa fa-caret-down"></i></div>
                    <div id="container-info" class="dropdown-content"></div>
                </div>
            </div>
        </div>
        <div id="node-detail"></div>
    </main>
</body>

</html>
