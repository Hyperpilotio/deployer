<!DOCTYPE html>
<html>

<head>
    <title>Deployer</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="stylesheet" type="text/css" href="/static/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/static/css/jquery.loadmask.css">
    <script src="/static/js/jquery-3.2.0.min.js"></script>
    <script src="/static/js/download.js"></script>
    <script src="/static/js/jquery.loadmask.min.js"></script>
    <script>
        $(function() {
            var realHeight = $('.deployment-list').height();
            $(".deployment-list").css('height', (realHeight + 100) + 'px');

            $('.deployment-list').on('click', 'li', function() {
                $('.deployment-list li').removeClass('active');
                $(this).addClass('active');

                $('main h1').remove();
                $('.deployment-detail').show();

                getDeploymentLog($(this).data('name'));

                if ($(this).data('status') == 'Deleted') {
                    $('.deployment-btn').hide();
                } else {
                    $('.deployment-btn').show();
                    if ($(this).data('type') == 'K8S') {
                        $('#downloadKubeconfigBtn').show();
                    } else if ($(this).data('type') == 'ECS') {
                        $('#downloadKubeconfigBtn').hide();
                    }
                }
            });

            $('#deleteBtn').click(function() {
                var logFileName = $('.deployment-list .active').data('name');
                var deploymentName = logFileName.replace('.log', '');
                if (confirm('Delete ' + deploymentName + 'deployment?')) {
                    $('body').mask('Waiting...');
                    $('.loadmask-msg').css('top', $(window).height() / 2);
                    $.ajax({
                        url: '/v1/deployments/' + deploymentName,
                        type: 'DELETE',
                        success: function(json) {
                            $('body').unmask();
                            getDeploymentLog(logFileName);
                            if (json.error == false) {
                                alert('Delete ok');
                            } else {
                                alert('Delete fail');
                            }
                        }
                    });
                }
            });

            $('#downloadSshKeyBtn').click(function() {
                var deploymentName = $('.deployment-list .active').data('name').replace('.log', '');
                $.ajax({
                    url: '/v1/deployments/' + deploymentName + '/ssh_key',
                    success: download.bind(true, 'text/plain', deploymentName + '-key')
                });
            });

            $('#downloadKubeconfigBtn').click(function() {
                var deploymentName = $('.deployment-list .active').data('name').replace('.log', '');
                $.ajax({
                    url: '/v1/deployments/' + deploymentName + '/kubeconfig',
                    success: download.bind(true, 'text/plain', 'kubeconfig')
                });
            });
        });

        function getDeploymentLog(logFileName) {
            $.ajax({
                url: '/ui/list/' + logFileName,
                type: 'GET',
                dataType: 'json',
                success: function(json) {
                    if (json.error == false) {
                        $('.deployment-log').html('');
                        $.each(json.data, function(i, line) {
                            $('.deployment-log').append('<p class="line">' + line + '</p>');
                        });
                    }
                }
            });
        }

       (function refresh() {
         setInterval(function(){
             $.ajax({
                 url: '/ui/refresh',
                 type: 'GET',
                 dataType: 'json',
                 success: function(json) {
                     if (json.error == false) {

                       let activeDeployment;
                       $( 'li.deployment' ).not(':first').each(function() {
                         if ($(this).hasClass('active')) {
                           activeDeployment = $(this).attr('data-name');
                         }
                         $(this).remove();
                       });

                       $(json.data).each(function(index, element) {
                         let deployment = $( '#deploymentTemplate' ).clone();
                         if (element.Name === activeDeployment) {
                           deployment.addClass('active');
                         }
                         deployment.attr('data-name', element.Name);
                         deployment.attr('data-type', element.Type);
                         deployment.attr('data-status', element.Status);
                         deployment.find('.logName').text(element.Name);
                         deployment.find('.logTime').text(element.Time);
                         deployment.find('.badge').text(element.Status);
                         deployment.find('.badge').addClass('badge-' + element.Status);
                         deployment.removeAttr('id style');
                         deployment.insertAfter('li.deployment:last');
                       })
                     }
                 }
             });

             let active = $( "li[class~='active']" ).get(0);
             if ( active ) {
               if ($(active).attr('data-status') !== 'Available') {
                 getDeploymentLog($( "li[class~='active']" ).get(0).dataset.name)
               }
             } else {
               $('.deployment-log').html('');
             }
           }, 2000);
         })();
    </script>
</head>

<body>
    <!-- header -->
    <header>
        <nav>
            <a href="/ui" class="banner">Deployer</a>
            <ul>
                <li>
                    <a href="/ui" class="active">deploys</a>
                </li>
            </ul>
        </nav>
    </header>

    <!-- sidebar -->
    <aside>
        <ul class="deployment-list">
          <li id="deploymentTemplate" class="deployment" style="display: none;" data-name data-type data-status>
            <div class="logName"></div>
            <span class="logTime"></span>
            <span class="badge"></span>
          </li>
          {{range $k,$v := .logs}}
          <li class="deployment" data-name="{{$v.Name}}" data-type="{{$v.Type}}" data-status="{{$v.Status}}">
              <div class="logName">{{$v.Name}}</div>
              <span class="logTime">{{$v.Time}}</span>
              <span class="badge badge-{{$v.Status}}">{{$v.Status}}</span>
          </li>
          {{end}}
        </ul>
    </aside>

    <!-- main -->
    <main>
        <div class="deployment-detail" style="display: none;">
            <div class="deployment-btn">
                <span id="deleteBtn" class="btn btn-danger"><i class="fa fa-trash-o"></i> Delete</span>
                <span id="downloadSshKeyBtn" class="btn btn-default"><i class="fa fa-download"></i> SSH_KEY</span>
                <span id="downloadKubeconfigBtn" class="btn btn-default" style="display: none;"><i class="fa fa-download"></i> Kubeconfig</span>
            </div>
            <h2>Deployment Log</h2>
            <div class="deployment-log">
            </div>
        </div>
    </main>
</body>

</html>
