<!DOCTYPE html>
<html>

<head>
<title>Deployer</title>
<link rel="import" href="/static/common/linkCss.html">
</head>

<body>
    <!-- header -->
    <header>
        <nav>
            <a href="/ui" class="banner">Deployer</a>
            <ul>
                <li>
                    <a href="/ui" class="active">deployments</a>
                </li>
                <li>
                    <a href="/ui/clusters">clusters</a>
                </li>
                <li>
                    <a href="/ui/users">users</a>
                </li>
            </ul>
        </nav>
    </header>

    <!-- sidebar -->
    <aside>
      <ul class="nav nav-tabs">
        <li class="active"><a href="#" data-status="Running">Running</a></li>
        <li><a href="#" data-status="Deleted">Deleted</a></li>
        <li><a href="#" data-status="Failed">Failed</a></li>
      </ul>
      <ul class="deployment-list">
        <li id="deploymentTemplate" class="deployment" style="display: none;" data-name data-type data-status>
          <div class="logName"></div>
          <span class="logTime"></span>
          <span class="badge"></span>
        </li>
        {{range $k,$v := .logs}}
        <li class="deployment" data-name="{{$v.Name}}" data-type="{{$v.Type}}" data-status="{{$v.Status}}">
            <div class="logName">{{$v.Name}}</div>
            <span class="logTime">{{$v.Time}}</span>
            <span class="badge badge-{{$v.Status}}">{{$v.Status}}</span>
        </li>
        {{end}}
      </ul>
    </aside>

    <!-- main -->
    <main>
        <div class="deployment-detail" style="display: none;">
            <div class="deployment-btn">
                <span id="deleteBtn" class="btn btn-danger"><i class="fa fa-trash-o"></i> Delete</span>
                <span id="downloadSshKeyBtn" class="btn btn-default"><i class="fa fa-download"></i> SSH_KEY</span>
                <span id="downloadKubeconfigBtn" class="btn btn-default" style="display: none;"><i class="fa fa-download"></i> Kubeconfig</span>
            </div>
            <h2>Deployment Log</h2>
            <div class="deployment-log">
            </div>
        </div>
    </main>
</body>
<link rel="import" href="/static/common/linkJs.html">
<script src="/static/js/download.js"></script>
<script src="/static/js/jquery.loadmask.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script>
  var runningInterval = null;
  $(function() {
    var realHeight = $('.deployment-list').height();
    $(".deployment-list").css('height', (realHeight + 100) + 'px');
    $('ul.nav-tabs a').on('click', function(event) {
      event.preventDefault();
      $('ul.nav-tabs li').removeClass('active');
      $(this).parent().addClass('active');
      if ($(this).data('status') !== 'Running') {
        $('.deployment-btn').hide();
      }
      refreshUI($(this).data('status'));
    });
    $('.deployment-list').on('click', 'li', function() {
      $('.deployment-list li').removeClass('active');
      $(this).addClass('active');
      if ($('ul.nav-tabs li').first().hasClass('active')) {
        $('.deployment-btn').show();
        if ($(this).data('type') == 'K8S') {
          $('#downloadKubeconfigBtn').show();
        } else if ($(this).data('type') == 'ECS') {
          $('#downloadKubeconfigBtn').hide();
        }
      }
      $('main h1').remove();
      $('.deployment-detail').show();
      getDeploymentLogContent($(this).data('name'));
    });
    $('#deleteBtn').click(function() {
      var logFileName = $('.deployment-list .active').data('name');
      var deploymentName = logFileName.replace('.log', '');
      if (confirm('Delete ' + deploymentName + 'deployment?')) {
        $('body').mask('Waiting...');
        $('.loadmask-msg').css('top', $(window).height() / 2);
        $.ajax({
          url: '/v1/deployments/' + deploymentName,
          type: 'DELETE',
          success: function(json) {
            $('body').unmask();
            getDeploymentLog(logFileName);
            if (json.error == false) {
                alert('Delete ok');
            } else {
                alert('Delete fail');
            }
          }
        });
      }
    });
    $('#downloadSshKeyBtn').click(function() {
      var deploymentName = $('.deployment-list .active').data('name').replace('.log', '');
      $.ajax({
        url: '/v1/deployments/' + deploymentName + '/ssh_key',
        success: download.bind(true, 'text/plain', deploymentName + '-key')
      });
    });
    $('#downloadKubeconfigBtn').click(function() {
      var deploymentName = $('.deployment-list .active').data('name').replace('.log', '');
      $.ajax({
        url: '/v1/deployments/' + deploymentName + '/kubeconfig',
        success: download.bind(true, 'text/plain', 'kubeconfig')
      });
    });
    refreshUI('Running');
  });
  function refreshUI(status) {
    clearInterval(runningInterval);
    runningInterval = setInterval(function fetchLog(){
      $.ajax({
        url: '/ui/list/' + status,
        type: 'GET',
        dataType: 'json',
        success: function(json) {
          if (json.error == false) {
            let activeDeployment;
            $( 'li.deployment' ).not(':first').each(function() {
              if ($(this).hasClass('active')) {
                activeDeployment = $(this).data('name');
              }
              $(this).remove();
            });
            $.each(json.data, function(index, element) {
              let deployment = $( '#deploymentTemplate' ).clone();
              if (activeDeployment && element.Name === activeDeployment) {
                deployment.addClass('active');
              }
              deployment.attr('data-name', element.Name);
              deployment.attr('data-type', element.Type);
              deployment.attr('data-status', element.Status);
              deployment.find('.logName').text(element.Name);
              deployment.find('.logTime').text(element.Time);
              deployment.find('.badge').text(element.Status);
              deployment.find('.badge').addClass('badge-' + element.Status);
              deployment.removeAttr('id style');
              deployment.insertAfter('li.deployment:last');
            })
          }
          if (status === 'Running') {
            let active = $('ul.deployment-list li[class~="active"]').get(0);
            if (active) {
              getDeploymentLogContent(active.dataset.name)
            } else {
              $('.deployment-log').hide();
            }
          }
        }
      });
      return fetchLog;
    }(), 10000);
    $('.deployment-log').hide();
  };
  function getDeploymentLogContent(logFileName) {
    $.ajax({
      url: '/ui/logs/' + logFileName,
      type: 'GET',
      dataType: 'json',
      success: function(json) {
        if (json.error == false) {
          $('.deployment-log').html('');
          $.each(json.data, function(i, line) {
              $('.deployment-log').append('<p class="line">' + line + '</p>');
          });
          $('.deployment-log').show();
        }
      }
    });
  }
</script>
</html>
